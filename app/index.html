<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas tarefas</title>
    <link preload href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link preload rel="stylesheet" type="text/css" href="styles.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container m-5 p-2 rounded mx-auto bg-light shadow" ng-app="myTodoList" ng-controller="myTodoController">
        <div class="row m-1 p-4">
            <div class="col">
                <div class="p-1 h1 text-primary text-center mx-auto display-inline-block">
                    <i class="fa fa-check bg-primary text-white rounded p-2"></i>
                    Minhas tarefas
                </div>
            </div>
        </div>
        <div class="row m-1 p-3">
            <div class="col col-11 mx-auto">
                <form  name="myForm">
                    <div class="row bg-white rounded shadow-sm p-2 align-items-center justify-content-center">
                        <div class="col-4">
                            <input class="form-control form-control-lg bg-transparent rounded" ng-model="newTask.title" type="text" placeholder="Nova tarefa ...">
                        </div>
                        <div class="col-3">
                            <input class="form-control form-control-lg  bg-transparent rounded" ng-model="newTask.resp_name" type="text" placeholder="Responsável">
                        </div>
                        <div class="col-4">
                            <input class="form-control form-control-lg bg-transparent rounded" ng-model="newTask.email" type="text" placeholder="Email">
                        </div>
                        <div class="col-auto px-0 mx-0 mr-2">
                            <button type="button" class="btn btn-primary p-2" ng-if="!loading"  ng-click="verifyEmail(newTask)">
                                <i class="fa fa-plus"  aria-hidden="true"></i>
                            </button>
                            <button type="button" class="btn btn-secondary p-2" ng-if="loading" >
                                <i class="fa fa-times"  aria-hidden="true"></i>
                            </button>
                        </div>
                </div>
                </form>
            </div>
        </div>
        <div class="p-2 mx-4 border-black-25 border-bottom"></div>
        <div class="row m-1 p-3">
            <div class="col col-md-5 mx-auto col-xs-12">
                <div class="row bg-white rounded shadow-sm p-2  align-items-center justify-content-center">
                    <div class="col">
                       <h3>Pendentes</h3>
                       <ul class="mt-4 p-0" ng-if="tasks">
                           <li class="row mt-4" ng-repeat="task in tasks" ng-if="task.status==0">
                                <div class="col-9 ">
                                    <h5>{{task.title}}</h5>
                                    <span>{{task.responsable}} <i>{{task.email}}</i></span>
                                </div>
                                <div class="col-3  text-center">
                                    <a ng-click="delTask($index)" ><i class="fa fa-times bg-danger text-white p-2" aria-hidden="true"></i></a>
                                    <a ng-click="doneTask($index)" ><i class="fa fa-check bg-primary text-white p-2" aria-hidden="true"></i></a>
                                </div>
                            </li>
                       </ul>
                    </div>

                </div>
            </div>

            <div class="col col-md-5 mx-auto col-xs-12">
                <div class="row bg-white rounded shadow-sm p-2  align-items-center justify-content-center">
                    <div class="col">
                        <h3>Concluídas</h3>
                        <ul class="mt-4 p-0" ng-if="tasks" >
                            <li class="row mt-4" ng-repeat="task in tasks" ng-if="task.status==1">
                                <div class="col-9 ">
                                    <h5>{{task.title}}</h5>
                                    <span>{{task.responsable}} <i>{{task.email}}</i></span>
                                </div>
                                <div class="col-3  text-center">
                                    <a ng-click="delTask($index)" ><i class="fa fa-times bg-danger text-white p-2" aria-hidden="true"></i></a>
                                    <a ng-click="undoTask($index)" title="Essa ação só pode ser feita 2x" ><i class="fa fa-undo bg-secondary text-white p-2" aria-hidden="true"></i></a>
                                </div>
                            </li>
                        </ul>
                     </div>

                 
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        var app = angular.module('myTodoList',[])
        app.controller('myTodoController', function($scope,$http) {

            $scope.loading = false;
            $scope.form = {};
            $scope.tasks  = [
                {"title":"Teste 1","resp_name":"Fabio","email":"fabioweydson@gmail.com", "status":0,"changes":0},
                {"title":"Teste 2","resp_name":"Fabio","email":"fabioweydson@gmail.com", "status":1,"changes":0}
            ];

            $scope.addTask = (newTask)=>{
               
                $scope.loading = true;
                $scope.form = angular.copy(newTask);
                // $http.post('http://localhost:9090', $scope.form).then(()=>{
                    console.log("tudo certo",newTask);
                    newTask.status = 0;
                    $scope.tasks.push(newTask)
                    console.log($scope.tasks)
                    $scope.loading = false;
                // }, ()=>{
                //     alert("Houston!");
                //     $scope.loading = false;
                // }, ()=>{ $scope.loading = false; });
               
            }

            $scope.delTask = (index)=>{
                let auth = window.prompt("Informe a senha do gestor");

                if(auth=="TrabalheNaSaipos") {
                    $scope.tasks.splice(index,1);
                } else { alert("Senha incorreta :(") }

            }

            $scope.undoTask = (index)=>{

                if($scope.tasks[index].changes<2) {
                    let auth = window.prompt("Informe a senha do gestor");
                    if(auth=="TrabalheNaSaipos") {
                        $scope.tasks[index].status = 0;
                        $scope.tasks[index].changes = $scope.tasks[index].changes+1;
                    } else { alert("Senha incorreta :(") }
                } else {
                    alert("Essa tarefa já alcançou o limite de mudanças :(")
                }
                console.log($scope.tasks)
                
            }

            $scope.doneTask = (index)=>{
                $scope.tasks[index].status = 1;
            }

            $scope.verifyEmail = (newTask)=>{
                $http.get(`http://apilayer.net/api/check?access_key=579eb9175c3199d072bfbd7ce28a0903&email=${newTask.email}&smtp=1&format=1`).then((res)=>{
                    if(res.data.did_you_mean) {
                    
                    window.confirm(`Você quis dizer ${mailVerification.did_you_mean}?`, ()=>{
                        $scope.form.email = mailVerification.did_you_mean;
                    });

                    } else if(res.data.format_valid) {
                        $scope.addTask(newTask);
                    } else if(!res.data.format_valid) {
                        alert("Email invalido!");
                        $scope.newTask.email = '';
                        $scope.loading = false;
                    }

                    return true;

                }).catch((error)=>{
                    return false;
                })
            }

        })

    </script>
</body>
</html>